<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>æ™ºèƒ½å®¶å±…æ§åˆ¶é¢æ¿</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    
    <!-- å¼•å…¥æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <!-- åˆå§‹éšè—ï¼Œé˜²æ­¢æ ·å¼åŠ è½½å‰çš„é—ªçƒ -->
    <style>
        body {
            visibility: hidden;
        }
        body.loaded {
            visibility: visible;
        }
    </style>

    <!-- èƒŒæ™¯å®¹å™¨ -->
    <div id="background-container"></div>

    <!-- ç§»åŠ¨ç«¯é¡¶éƒ¨é¡µçœ‰å®¹å™¨ -->
    <div class="mobile-headerbar-container" id="mobile-headerbar">
        <!-- é¡µçœ‰å†…å®¹å°†åŠ¨æ€åŠ è½½ -->
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-content" id="main-content">
        <!-- è®¾å¤‡å¡ç‰‡å®¹å™¨ -->
        <div id="deviceCardsContainer"></div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <nav class="bottom-nav">
        <div class="nav-item active" data-page="home">
            <div class="nav-icon">ğŸ </div>
            <div class="nav-text">é¦–é¡µ</div>
        </div>
        <div class="nav-item" data-page="scenes">
            <div class="nav-icon">ğŸ¬</div>
            <div class="nav-text">åœºæ™¯</div>
        </div>
        <div class="nav-item" data-page="settings">
            <div class="nav-icon">âš™ï¸</div>
            <div class="nav-text">è®¾ç½®</div>
        </div>
    </nav>

    <!-- å¼•å…¥Vue -->
    <script src="libs/vue.global.js"></script>

    <!-- å¼•å…¥SortableJS - ç”¨äºiOSé£æ ¼æ‹–æ”¾åŠ¨ç”» -->
    <script src="libs/sortablejs.js"></script>


    <!-- å¼•å…¥é…ç½®æ–‡ä»¶ -->
    <script src="config/config.js"></script>
    <script src="config/device_config.js"></script>

    <!-- å¼•å…¥HAè¿æ¥ã€WebSocketã€çŠ¶æ€ç®¡ç†å™¨ã€å®šæ—¶å™¨ç®¡ç†å™¨ã€è®¾å¤‡æ§åˆ¶å’Œè®¾ç½®åŒæ­¥ -->
    <script src="app/ha-connection.js"></script>
    <script src="app/websocket-manager.js"></script>
    <script src="app/state-manager.js"></script>
    <script src="app/timer-manager.js"></script>
    <script src="app/device-controller.js"></script>
    <script src="app/ha-settings-sync.js"></script>
    
    <!-- æ³¨å†Œ Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // æ£€æŸ¥æ˜¯å¦åœ¨æ”¯æŒçš„åè®®ä¸‹è¿è¡Œï¼ˆfile:// ä¸æ”¯æŒ Service Workerï¼‰
                if (window.location.protocol === 'file:') {
                    console.log('[SW] æœ¬åœ°æ–‡ä»¶åè®®ä¸æ”¯æŒ Service Workerï¼Œè·³è¿‡æ³¨å†Œ');
                    return;
                }

                // æ£€æµ‹æ˜¯å¦åœ¨ HA App å†…
                const isHAApp = /HomeAssistant/i.test(navigator.userAgent) ||
                               /com.homeassistant.companion.android/i.test(navigator.userAgent) ||
                               /com.homeassistant.companion.ios/i.test(navigator.userAgent) ||
                               window.location.hostname.includes('192.168');

                // åªåœ¨é HA App ç¯å¢ƒä¸‹æ³¨å†Œ Service Worker
                if (!isHAApp) {
                    navigator.serviceWorker.register('sw.js')
                        .then(registration => {
                            console.log('[SW] æ³¨å†ŒæˆåŠŸ:', registration.scope);
                        })
                        .catch(error => {
                            console.log('[SW] æ³¨å†Œå¤±è´¥:', error);
                        });
                } else {
                    console.log('[SW] æ£€æµ‹åˆ° HA App ç¯å¢ƒï¼Œè·³è¿‡ Service Worker æ³¨å†Œ');
                }
            });
        }
    </script>

    <!-- å¡ç‰‡ç»„ä»¶ç”± config.js çš„ cards é…ç½®ç»Ÿä¸€åŠ è½½ï¼Œæ— éœ€åœ¨æ­¤é€ä¸ªå¼•å…¥ï¼›åŠ è½½å®Œæˆåå†åŠ è½½ index.js -->
    <script src="app/cards-loader.js"></script>
</body>
</html>
